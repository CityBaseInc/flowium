<!DOCTYPE html>
<html lang="en">
<head>
  <title>flowium</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="flowium.css">
  <script src="utils.js"></script>
</head>
<script>

intro = `
In the IT industry there's a certain kind of knowledge that is never written
down, knowledge that is passed down by oral tradition, knowledge that slowly
dissipates at the best of times and is abruptly lost when people move to
different jobs.

It's knowledge about processes that are too vague to automate, too complex
to fully formalize, too volatile to keep any documentation up-to-date.
It's things like "How do you get a new major release out of the door?",
"How to reconfigure the company network?" or "How to build a new datacenter?"

These processes often require coordination between many parties. Often
they involve manual steps like "Order the machines and wait until they are
delivered." oftentimes they are long-lived, requiring handing over the work
between people, and almost always they change and then change
again, without much warning, while the work is still in progress.

Once in a while someone gets desparate and writes the process down. But soon
enough the document becomes outdated, people stop using it and finally it
gets lost.

Flowium tries to solve that problem, but it is in no way a silver bullet.
It doesn't propose anything better than sitting down and writing down a
document about the process. However, once the document is written it uses that
document as a tool to guide people through the process, to communicate between
the involved parties, to keep track of what was and what wasn't done.

The hope is that if the documentation is helpful, in a very down-to-earth and
practical way, people will be incentivized to use it, to improve it and to keep
it up-to-date.

All that being said, Flowium is not a tool to impose strict processes on the
users. It provides guidance but defers the decision to users. If you are looking
for a way to enforce rules it is not the tool you are looking for.`

example = `
Seeing is believing. Have a look for yourself.

[This is a document describing a simple process](https://raw.githubusercontent.com/sustrik/flowium-sandbox/master/release.md)

It's a standard Markdown document, with a simple extension to define
dependencies between steps of the process (look for wiggly arrows, ~>).
It describes how to create a new release of *Frobnicator* application.

[Click here to start the process](javascript:createSandboxIssue())`

howItWorks = `
Flowium is a client-side web application, a simple shim on top of GitHub.
It reads your Markdown document from GitHub and uses it to create an issue in
GitHub's issue tracker.

It splits the document into sections and allows you to mark those section as
either done or not done. It also gives you an opportunity to comment on
individual sections.

Furthermore, there's a simple syntax that you can use to define dependencies
between the individual steps in the document. If you do so Flowium will also
show whether a step is active or blocked by an unfinished step that it depends
on.

At any point you can look at the graph of the workflow to get a quick idea
about what was already done and what still remains to be done.

Finally, there's a syntax to define variables (user will be asked to fill
the values in) and syntax to expand those variables in the text of the document.
`

reference = `
To define a step:

\`\`\`
# Title of the step ~> step-id: dependency-1 dependency-2 dependency-3
\`\`\`

All the text before the first step definition is ignored.

To ask for user input:

\`\`\`
* First name: ~> first-name
* Last name: ~> last-name
* Date of birth: ~> birth-date 
\`\`\`

To expand the variables filled in by the user:

\`\`\`
Your name is #{first-name} #{last-name}
and you were born on #{birth-date}.
\`\`\`
`

function createIssue(repository, template, title, comment) {
    // Get the current version of the template.
    ghGet(`repos/${repository}/commits?path=${template}`, null,
          function(commits) {
        var sha = commits[0].sha
        var prologue = '~> _template: ' + template + ":" + sha + "\n\n"
        // Create the issue.
        var args = {
            "title": title,
            "body": prologue + comment,
            "labels": ["flowium"],
        }
        ghPost(`repos/${repository}/issues`, args, function(reply) {
            var addr = 'issue.html' +
                '?repository=' + encodeURIComponent(repository) +
                '&issue=' + reply.number
            var body = `View in Flowium: <https://flowium.com/${addr}>`
            ghPost(`repos/${repository}/issues/${reply.number}/comments`,
                  {"body": body}, function(reply) { 
                window.location.href = addr
            })
        })
    })
}

function createSandboxIssue() {
    createIssue(
        "sustrik/flowium-sandbox",
        "/release.md",
        "Release Frobnicator",
        "It's time to make a new release!")
}

function loadTemplates(repository, path) {
    ghGet(`repos/${repository}/contents${path}`, null, function(files) {
        $("#create-path").empty()
        $("#file-table").empty()
        // Fill in the file path.
        var elems = path.split("/")
        elems.pop()
        var partial = ""
        for(var i = 0; i < elems.length; i++) {
            partial += elems[i] + "/"
            var caption = elems[i]
            if(elems[i] == "") caption = "$"
            var a = $("<a></a>").text(caption)
            a.attr("href",
                `javascript:loadTemplates("${repository}", "${partial}")`)
            var li = $(`<li class="breadcrumb-item"></li>`).append(a)
            $("#create-path").append(li)
        }
        // Fill in the file list.
        var dirs = {}
        for(var i = 0; i < files.length; i++) {
            var f = files[i]
            if(f.type != "dir") continue
            dirs[f.name] = (function (newpath) {return function() {
                loadTemplates(repository, newpath)
            }})(`${path}${f.name}/`)
        }
        var tfiles = {}
        for(var i = 0; i < files.length; i++) {
            var f = files[i]
            if(f.type != "file") continue
            if(!f.name.endsWith('.md')) continue
            tfiles[f.name] = (function (tname) {return function() {                
                var li = $(`<li class="breadcrumb-item active"></li>`)
                li.text(tname)
                $("#create-path").append(li)
            }})(f.name)
        }
        var items = []
        var keys = Object.keys(dirs).sort()
        for(var i = 0; i < keys.length; i++)
            items.push([keys[i], dirs[keys[i]], "fa-folder-o"])
        keys = Object.keys(tfiles).sort()
        for(var i = 0; i < keys.length; i++)
            items.push([keys[i], tfiles[keys[i]], "fa-file-o"])
        for(var i = 0; i < items.length; i++) {
            var t = $(`<tr class="clickable-element"></tr>`).click(items[i][1])
            t.append($(`<td><i class="fa ${items[i][2]}"></i></td>`))
            t.append($("<td></td>").text(items[i][0]))
            $("#file-table").append(t)
        }
    })
}



$(document).ready(function() {
    // Authenticate with GitHub, as needed.
    authenticate()

    $(".section-body").hide()
    $(".section-header").click(function () {
        var hidden = $(this).next().is(":hidden")
        $(".section-body").hide()
        if(hidden) $(this).next().show()
    })
    $("#intro").append(mdConvert(intro))
    $("#example").append(mdConvert(example))
    $("#how-it-works").append(mdConvert(howItWorks))
    $("#reference").append(mdConvert(reference))

    // Fill in the "recent issues" tab.
    var recent = JSON.parse(localStorage.getItem("recent"))
    var recentRepositories = {}
    if(recent != null) {
        for(var i = 0; i < recent.length; i++) {
            var issue = recent[i]
            recentRepositories[issue.repository] = null
            var t = $(`<tr class="clickable-element"></tr>`).click(function() {
                var cols = $(this).children("td")
                var repository = cols.eq(0).text()
                var issue = cols.eq(1).text().substring(1)
                window.location.href =
                    `issue.html?repository=${encodeURIComponent(repository)}` +
                    `&issue=${issue}`
            })
            t.append($("<td></td>").text(issue.repository))
            t.append($("<td></td>").text(`#${issue.issue}`))
            t.append($("<td></td>").text(issue.title))
            $("#recent-issue-table").append(t)
        }
    }
    
    // Use the repositories from the recent issues to pre-fill the repository
    // drop-down lists.
    recentRepositories = Object.keys(recentRepositories).sort()
    for(var i = 0; i < recentRepositories.length; i++) {
        $("#repository-list")
            .append($("<option/>")
            .attr("value", recentRepositories[i]))
    }

    // Fill in the "find an issue" tab.
    // When new repository is selected, read all the issues from GitHub
    // and put them into the table.
    $("#find-repository").change(function () {
        var repository = $("#find-repository").val()
        $("#find-issue-table").empty()
        ghGet(`repos/${repository}/issues`, null, function(issues) {
            for(var i = 0; i < issues.length; i++) {
                var issue = issues[i]
                // Skip non-flowium issues.
                var isFlowiumIssue = false
                for(var j = 0; j < issue.labels.length; j++) {
                    if(issue.labels[j].name == "flowium") {
                        isFlowiumIssue = true
                        break
                    }
                }
                if(!isFlowiumIssue) continue
                var t = $(`<tr class="clickable-element"></tr>`).click(
                      function() {
                    var cols = $(this).children("td")
                    var repository = cols.eq(0).text()
                    var issue = cols.eq(1).text().substring(1)
                    window.location.href =
                        "issue.html" +
                        `?repository=${encodeURIComponent(repository)}` +
                        `&issue=${issue}`
                })
                t.append($("<td></td>").text(repository))
                t.append($("<td></td>").text(`#${issue.number}`))
                t.append($("<td></td>").text(issue.title))
                $("#find-issue-table").append(t)
            }
        })
    })

    // Fill in the "create an issue" tab.
    // When repository is selected, start browsing files.
    $("#create-repository").change(function () {
        var repository = $("#create-repository").val()
        loadTemplates(repository, "/")
    })
    $("#create-button").click(function() {
        // Collect the info from the form.
        var repository = $("#create-repository").val()
        var elems = $("#create-path").children()
        var template = ""
        for(var i = 1; i < elems.length; i++)
            template += "/" + elems.eq(i).text()
        var title = $("#create-title").val()
        var comment = $("#create-comment").val()
        createIssue(repository, template, title, comment)
    })
})

</script>
<body>
  
<div class="container-fluid">

  <h1 class="flowium-title">Flowium</h1>

  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" data-toggle="tab" href="#home">
          Home</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-toggle="tab" href="#recent-issues">
          Recent</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-toggle="tab" href="#find-issue">
          Find</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-toggle="tab" href="#create-issue">
          Create</a>
    </li>
  </ul>

  <div class="tab-content">

    <datalist id="repository-list"></datalist>

    <div id="home" class="container tab-pane active"><br>
      <h3>Home</h3>
      <br>
      <div class="card flowium-step">
        <div class="card-header flowium-card-header section-header">
          <h5 class="step-title">What is Flowium?</h5>
        </div>
        <div id="intro" class="card-body section-body step-body"></div>
      </div>
      <div class="card flowium-step">
        <div class="card-header flowium-card-header section-header">
          <h5 class="step-title">Show me an example!</h5>
        </div>
        <div id="example" class="card-body section-body"></div>
      </div>
      <div class="card flowium-step">
        <div class="card-header flowium-card-header section-header">
          <h5 class="step-title">How does it work?</h5>
        </div>
        <div id="how-it-works" class="card-body section-body"></div>
      </div>
      <div class="card flowium-step">
        <div class="card-header flowium-card-header section-header">
          <h5 class="step-title">Reference</h5>
        </div>
        <div id="reference" class="card-body section-body"></div>
      </div>
    </div>

    <div id="recent-issues" class="container tab-pane fade"><br>
      <h3>Recent issues</h3>
      <br>
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Repository</th>
            <th>Issue</th>
            <th>Title</th>
          </tr>
        </thead>
        <tbody id="recent-issue-table"></tbody>
      </table>
    </div>

    <div id="find-issue" class="container tab-pane fade"><br>
      <h3>Find an issue</h3>
      <br>
      <div class="form-group">
        <label for="find-repository">
            GitHub repository (e.g. <i>johndoe/myproject</i>):</label>
        <input type="text" class="form-control" id="find-repository"
            list="repository-list">
      </div>
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Repository</th>
            <th>Issue</th>
            <th>Title</th>
          </tr>
        </thead>
        <tbody id="find-issue-table"></tbody>
      </table>
    </div>

    <div id="create-issue" class="container tab-pane fade"><br>
      <h3>Create an issue</h3>
      <br>
      <div class="form-group">
        <label for="create-repository">
            GitHub repository (e.g. <i>johndoe/myproject</i>):</label>
        <input type="text" class="form-control" id="create-repository"
            list="repository-list">
      </div>
      <div class="form-group">
        <label for="create-template">Template file:</label>
        <ul id="create-path" class="breadcrumb"></ul>
        <table class="table table-hover" id="create-template">
          <tbody id="file-table"></tbody>
        </table>
      <div>
      <div class="form-group">
          <label for="create-title">Issue title:</label>
          <input type="text" class="form-control" id="create-title"></input>
      </div>
      <div class="form-group">
        <label for="create-comment">Comment:</label>
        <textarea class="form-control" id="create-comment" rows="10"></textarea>
      </div>
      <button id="create-button" type="button" class="btn btn-primary">
          Create</button>
    </div>

  </div>

</div>

</body>
</html>
