<!DOCTYPE html>
<html lang="en">
<head>
  <title>flowium</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://unpkg.com/viz.js@1.8.0/viz.js" type="javascript/worker"></script>
  <script src="https://unpkg.com/d3-graphviz@1.4.0/build/d3-graphviz.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="flowium.css">
  <script src="utils.js"></script>
</head>
<script>

////////////////////////////////////////////////////////////////////////////////
//  Parsing the flow source code.
////////////////////////////////////////////////////////////////////////////////

function parseSteps(source, variables) {
    var lns = source.split("\n")
    var steps = []
    var stepname = null
    var step = ""
    var title = ""
    var deps = []
    var inputs = ""
    for(var i = 0; i < lns.length; i++) {
        var ln = lns[i]
        if(ln.startsWith("#") && ln.includes("~>")) {
            if(stepname != null) {
                steps.push({
                    id: stepname,
                    title: title,
                    body: step,
                    deps: deps
                })
            }
            title = ""
            step = ""
            deps = []
            var ruleparts = splitOnce(ln, "~>")
            title = ltrimChar(ruleparts[0], "#").trim()
            var elems = splitOnce(ruleparts[1].trim(), ":")
            stepname = elems[0].trim()
            if(elems.length > 1) {
                d = elems[1].trim().split(/\s+/)
                for(var j = 0; j < d.length; j++) {
                    deps.push(d[j])
                }
            }
            continue
        }
        if(ln.startsWith("*") && ln.includes("~>")) {
            if(inputs == "") {
                inputs = `<div class="card flowium-input">
                    <div class="card-body">`
            }
            var elems = splitOnce(ltrimChar(ln, "*"), "~>")
            var varname = elems[1].trim()
            var val = ""
            if(varname in variables) val = escapeHtml(variables[varname]) 
            inputs += `
                <div class="form-group">
                    <label>${elems[0].trim()}</label>
                    <input type="text" class="form-control" value="${val}"/>
                </div>`
            continue
        }
        if(inputs.length > 0) {

            step += `<div>${inputs}<p><button type="button"
                class="btn btn-secondary">Save</button></p></div></div></div>`
            inputs = ""
        }
        step += ln + "\n"
    }
    if(inputs.length > 0) {
        step += `<div>${inputs}<p><button onclick="saveVariables(this)">` +
            `Save</button></p></div>`
        inputs = ""
    }
    if(stepname != null) {
        steps.push({
            id: stepname,
            title: title,
            body: step,
            deps: deps
        })
    }

    // Expand the variables.
    var keys = Object.keys(variables)
    for(var i = 0; i < steps.length; i++) {
        for(var j = 0; j < keys.length; j++) {
            var val = variables[keys[j]] 
            steps[i].body = steps[i].body.replace(
                new RegExp('#{' + keys[j] + '}', 'g'),
                escapeHtml(val))
        }
    }

    return steps
}

function annotateStepsWithStatus(steps, sysvars) {
    var statuses = {}
    // Check whether steps are done or not done.
    for(var i = 0; i != steps.length; i++) {
        var status = "not-done"
        var vname = "_status+" + steps[i].id
        if(vname in sysvars)
            status = sysvars[vname]
        steps[i]["status"] = status
        statuses[steps[i].id] = status
    }
    // Steps that are not yet done can be also blocked.
    for(var i = 0; i != steps.length; i++) {
        if(steps[i].status == "done") {
            steps[i]["dstatus"] = "done"
            steps[i]["blockedBy"] = []
            continue
        }
        var deps = steps[i].deps
        var blockedBy = []
        for(j = 0; j < deps.length; j++) {
            if(statuses[deps[j]] != "done") {
                blockedBy.push(deps[j])
            }
        }
        steps[i]["blockedBy"] = blockedBy
        if(blockedBy.length == 0) steps[i]["dstatus"] = "active"
        else steps[i]["dstatus"] = "blocked"
    }
}

function annotateStepsWithComments(steps, comments) {
    for(var i = 0; i != steps.length; i++) {
        var step = steps[i]
        var res = []
        for(var j = 0; j != comments.length; j++) {
            var comment = comments[j]
            if(comment.type != "step-comment" || !("step" in comment)) continue
            if(comment.step != step.id) continue
            res.push(comment)
        }
        step['comments'] = res
    }
}

////////////////////////////////////////////////////////////////////////////////
//  Preprocessing comments.
////////////////////////////////////////////////////////////////////////////////

function splitVariables(res, text) {
    var userVariables = {}
    var systemVariables = {}
    var lns = text.split('\n')
    for(var i = 0; i < lns.length; i++) {
        var ln = lns[i]
        var vdef = splitOnce(lns[i].substring(2), ":")
        var name = vdef[0].trim()
        if(vdef.length < 2) {
            var value = ""
        } else {
            var value = vdef[1].trim()
        }
        if(name.startsWith("_")) systemVariables[name] = value
        else userVariables[name] = value
    }
    if(Object.keys(systemVariables).length > 0)
        res.push({type: 'sysvars', vars: systemVariables})
    if(Object.keys(userVariables).length > 0)
        res.push({type: 'vars', vars: userVariables})
}

function splitCommentsAndVariables(text) {
    var res = []
    var variable = true
    var body = ""
    var lns = text.split('\n')
    for(var i = 0; i < lns.length; i++) {
        if(lns[i].startsWith("~>")) {
            if(!variable && body != "") {
                if(body.trim().length > 0)
                    res.push({type: "comment", body: body.trim()})
                body = ""
            }
            variable = true
        } else {
            if(variable && body != "") {
                splitVariables(res, body.trim())
                body = ""
            }
            variable = false
        }
        body += "\n" + lns[i]
    }
    if(variable) {
        splitVariables(res, body.trim())
    } else {
        if(body.trim().length > 0)
            res.push({type: "comment", body: body.trim()})
    }

    // Pair comments to steps.
    var step = null
    for(var i = 0; i < res.length; i++) {
        var it = res[i]
        if(it.type == 'sysvars' && "_step" in it.vars) {
            step = it.vars["_step"]
            delete it.vars["_step"]
            if(Object.keys(it.vars).length == 0) {
                res.splice(i, 1)
                i--
            }
            continue    
        }
        if(step != null && it.type == "comment") {
            it.type = "step-comment"
            it.step = step
        }
    }

    return res
}

function processComments(comments) {
    var res = []
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        sc = splitCommentsAndVariables(c.body)
        for(var j = 0; j < sc.length; j++) {
            sc[j].userName = c.user.login
            sc[j].userUrl = c.user.html_url
            sc[j].userAvatar = c.user.avatar_url
            sc[j].createdAt = new Date(c.created_at).toLocaleString()
            res.push(sc[j])
        }
    }
    return res
}

function extractVariablesFromComments(comments, type) {
    var result = {}
    for(var i = 0; i < comments.length; i++) {
        if(comments[i].type == type) {
            result = Object.assign(result, comments[i].vars)
        }
    }
    return result
}

////////////////////////////////////////////////////////////////////////////////
//  Steps.
////////////////////////////////////////////////////////////////////////////////

function initSteps(steps) {
    console.log(steps)
    for(var i = 0; i < steps.length; i++) {
        var step = steps[i]
        var card = $(`<div class="card flowium-step"></div>`)
        var hdr = $(`<div class="card-header step-header"></div>`)
        hdr.append($(`<h5 class="step-title"></h5>`).text(step.title)
            .prepend(`<i class="fa fa-circle comment-icon ` +
            `${step.dstatus}-font">`))
        hdr.click(function () {
            var hidden = $(this).next().is(":hidden")
            $(".step-body").hide()
            if(hidden) $(this).next().show()
        })
        card.append(hdr)
        var body = $(`<div class="card-body step-body" ` +
            `style="display: none;"></div>`)
        if(step.blockedBy.length > 0) {
            var a = $(`<div class="alert alert-danger" role="alert"></div>`)
            a.append(`This step is blocked by: `)
            for(var j = 0; j < step.blockedBy.length; j++) {
                a.append($("<span></span>").text(step.blockedBy[j]+ " "))
            }
            body.append(a)
        }
        body.append(mdConvert(step.body))
        for(var j = 0; j < step.comments.length; j++) {
            body.append(renderComment(step.comments[j], null, null,
                mdSanitizeAndConvert(step.comments[j].body)))
        }
        body.append(`<div class="form-group"><textarea class="form-control"
            id="history-comment" rows="4"></textarea></div>`)
        if(step.status == "done") {
            body.append(`<button type="button"
                class="btn btn-primary">Not done</button>`)
        } else {
            body.append(`<button type="button"
                class="btn btn-primary">Comment</button><button type="button"
                class="btn btn-primary">Done</button>`)
        }
        card.append(body)
        $("#steps-main").append(card)
    }
}

////////////////////////////////////////////////////////////////////////////////
//  Graph.
////////////////////////////////////////////////////////////////////////////////

function initGraph(steps) {
    var dot =`
        digraph "" {
        node [
            shape=box
            fontname="Helvetica"
            fontsize=10
            width=0
            height=0
            tooltip=" "
        ]
        `
    for(var i = 0; i < steps.length; i++) {
        var s = steps[i]
        dot += `
            "${s.id}" [
                label="${s.title}"
                style=filled
                fillcolor="${statusToColor(s.dstatus)}"
                URL="javascript:scrollToStep('${s.id}');"
            ]
            `
        for(var j = 0; j < s['deps'].length; j++) {
            if(s['deps'][j].trim() != '') {
                dot += `
                    "${s.deps[j]}" -> "${s.id}"
                `
            }
        }
    }
    dot += "}"
    d3.select("#graph-main").graphviz().fade(false).renderDot(dot)
}

////////////////////////////////////////////////////////////////////////////////
//  Input.
////////////////////////////////////////////////////////////////////////////////

function initInput(repository, issue, vars) {
    var keys = Object.keys(vars).sort()
    for(var i = 0; i < keys.length; i++) {
        var tr = $(`<tr class="clickable-element"></tr>`)
        tr.click((function(name, value) {return function() {
            $("#input-name").val(name)
            $("#input-value").val(value)
        }})(keys[i], vars[keys[i]]))
        tr.append($("<td></td>").text(keys[i]))
        tr.append($("<td></td>").text(vars[keys[i]]))
        $("#input-table").append(tr)
    }

    // When the button is pressed one input is updated.
    $("#input-save").click(function () {
        var name = $("#input-name").val()
        var value = $("#input-value").val()
        var body = `~> ${name}: ${value}`
        ghPost(`repos/${repository}/issues/${issue}/comments`,
              {"body": body}, function(reply) { 
            location.reload();
        })
    })
}

////////////////////////////////////////////////////////////////////////////////
//  History.
////////////////////////////////////////////////////////////////////////////////

function renderComment(comment, icon, iconText, text) {
    var hdr = $(`<div class="card-header"></div>`)
    hdr.append($(`<img class="comment-avatar"/>`)
        .attr("src", comment.userAvatar + "&s=44"))
    hdr.append($("<a></a>").attr("href", comment.userUrl)
        .text(comment.userName))
    hdr.append($(`<span></span>`).text("  " + comment.createdAt))
    var card = $(`<div class="card flowium-comment"></div>`)
    card.append(hdr)
    var body = $(`<div class="card-body"></div>`)
    if(icon != null) {
        var ic = $(`<p><i class="fa ${icon} comment-icon"></i></p>`)
            .append(iconText)
    }
    body.append($("<b></b>").html(ic))
    body.append(text) 
    card.append(body)
    return card
}

function initHistory(repository, issue, comments, steps) {
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var icon = "fa-exclamation-triangle"
        var iconText = "Unknown comment type"
        var text = ""
        if(c.type == "comment") {
            icon = "fa-pencil"
            iconText = "Comment"
            text = mdSanitizeAndConvert(c.body)
        }
        if(c.type == "step-comment") {
            icon = "fa-pencil-square-o"
            var step = c.step
            for(var j = 0; j < steps.length; j++) {
                if(steps[j].id === c.step) {
                    step = steps[j].title
                    break;
                }
            }
            iconText = `Comment on step "${step}"`
            text = mdSanitizeAndConvert(c.body)
        }
        if(c.type == "vars") {
            icon = "fa-question"
            iconText = "Input"
            text = ""
            var names = Object.keys(c.vars).sort()
            for(var j = 0; j < names.length; j++) {
                text += `<p>Input <b>${escapeHtml(names[j])}</b> set to ` +
                    `<b>${escapeHtml(c.vars[names[j]])}</b>.</p>`
            }
        }
        if(c.type == "sysvars") {
            var icon = "fa-cog"
            var iconText = "System variable"
            var text = ""
            // TODO: Render different system variables.
        }
        $("#history-main").append(renderComment(c, icon, iconText, text))
        // Clicking on the button creates a global comment.
        $("#comment-button").click(function () {
            var body = $("#history-comment").val()
            ghPost(`repos/${repository}/issues/${issue}/comments`,
                  {"body": body}, function(reply) { 
                location.reload();
            })
        })
    }
}

////////////////////////////////////////////////////////////////////////////////
//  Main.
////////////////////////////////////////////////////////////////////////////////

$(document).ready(function() {
    authenticate()
    // Parse query string.
    var urlParams = new URLSearchParams(window.location.search)
    var issueRepository = urlParams.get("repository")
    var issueNumber = urlParams.get("issue")
    // Get the data from GitHub.
    ghGet(`repos/${issueRepository}/issues/${issueNumber}`, null,
          function(issue) {
        ghGet(`repos/${issueRepository}/issues/${issueNumber}/comments`, null,
              function(cmnts) {
            $("#title").text(issue.title)
            $(document).attr("title", issue.title);
            cmnts.unshift(issue)
            var comments = processComments(cmnts)
            var sysvars = extractVariablesFromComments(comments, "sysvars")
            var vars = extractVariablesFromComments(comments, "vars")
            var template = sysvars["_template"].split(':')
            ghGet(`repos/${issueRepository}/contents/${template[0]}` +
                  `?ref=${template[1]}`, {}, function(src) {
                var steps = parseSteps(atob(src.content), vars)
                annotateStepsWithStatus(steps, sysvars)
                annotateStepsWithComments(steps, comments)
                initSteps(steps)
                initGraph(steps)
                //initInput(issueRepository, issueNumber, vars)
                initHistory(issueRepository, issueNumber, comments, steps)
                // Add the issue to the list of recent issues.
                var recent = JSON.parse(localStorage.getItem("recent"))
                if(recent == null) recent = []
                recent = recent.filter(function(it) {
                    return it.repository != issueRepository ||
                        it.issue != issueNumber
                })
                recent.unshift({
                    repository: issueRepository,
                    issue: issueNumber,
                    title: issue.title,
                })
                recent = recent.slice(0, 20)
                localStorage.setItem("recent", JSON.stringify(recent))
            })
        })
    })
})

</script>
<body>
  
<div class="container-fluid">

  <h1 id="title" class="flowium-title"></h1>

  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" data-toggle="tab" href="#steps">
          Steps</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-toggle="tab" href="#graph">
          Graph</a>
    </li>
<!--
    <li class="nav-item">
      <a class="nav-link" data-toggle="tab" href="#input">
          Input</a>
    </li>
-->
    <li class="nav-item">
      <a class="nav-link" data-toggle="tab" href="#history">
          History</a>
    </li>
  </ul>

  <div class="tab-content">

    <div id="steps" class="container tab-pane active"><br>
      <h3>Steps</h3>
      <br> 
      <div id="steps-main"></div>
    </div>

    <div id="graph" class="container tab-pane fade"><br>
      <h3>Workflow graph</h3>
      <p>This graph shows the dependencies between the steps. The steps are clickable.</p>
      <br>
      <div id="graph-main"></div>
      <br>
      <p><i class="fa fa-circle comment-icon done-font"></i>Steps that are done are grey.</p>
      <p><i class="fa fa-circle comment-icon active-font"></i>Active steps are green.</p>
      <p><i class="fa fa-circle comment-icon blocked-font"></i>Blocked steps are red.</p>
    </div>

<!--
    <div id="input" class="container tab-pane fade"><br>
      <h3>Input variables</h3>
      <br>
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Name</th>
            <th>Value</th>
          </tr>
        </thead>
        <tbody id="input-table"></tbody>
      </table>
      <div class="form-group">
          <label for="input-name">Name:</label>
          <input type="text" class="form-control" id="input-name"></input>
      </div>
      <div class="form-group">
          <label for="input-value">Value:</label>
          <input type="text" class="form-control" id="input-value"></input>
      </div>
      <button id="input-save" type="button" class="btn btn-primary">
          Save</button>
    </div>
-->

    <div id="history" class="container tab-pane fade"><br>
      <h3>History of the issue</h3>
      <br>
      <div id="history-main"></div>
      <br>
      <div class="form-group">
        <textarea class="form-control" id="history-comment" rows="6"></textarea>
      </div>
      <button id="comment-button" type="button" class="btn btn-primary">
          Comment</button>
    </div>

  </div>

</div>

</body>
</html>
