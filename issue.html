<!DOCTYPE html>
<html lang="en">
<head>
  <title>flowium</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://unpkg.com/viz.js@1.8.0/viz.js" type="javascript/worker"></script>
  <script src="https://unpkg.com/d3-graphviz@1.4.0/build/d3-graphviz.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="flowium.css">
  <script src="utils.js"></script>
</head>
<script>

////////////////////////////////////////////////////////////////////////////////
//  Parsing the template.
////////////////////////////////////////////////////////////////////////////////

// Checks whether ID is valid.
function testId(id) {
    var re = /^([a-zA-Z0-9-]+)|("[^"]*")$/
    if(!re.test(id)) throw `Invalid ID ${id}.`
}

// Function parseHeading gets a line with markdown heading and returns
// the following object:
//
// {
//     id: <short ID of the step>,
//     title: <human readable title of the step>,
//     deps: <array of step IDs of this step depends on>,
// }

function parseHeading(ln) {
    // If there is no ID specified by the user we'll user the heading itself
    // as an ID encolsed in double quotes. If there are double quotes in the
    // heading text they will be replaced by single quotes.
    if(!ln.includes("~>"))
        return {id: '"' + ln.replace('"', '"') + '"', title: ln, deps: []}
    // Format of the Flowium heading line: Title ~> foo: bar baz
    var parts = splitOnce(ln, "~>")
    var title = parts[0].trim()
    parts = splitOnce(parts[1], ":")
    var id = parts[0].trim()
    testId(id)
    var deps = []
    if(parts.length > 1) {
        parts = parts[1].split(/\s+/)
        for(var i = 0; i < parts.length; i++) {
            var dep = parts[i].trim()
            if(dep.length == 0) continue
            testId(dep)
            deps.push(dep)
        }
    }
    return {id: id, title: title, deps: deps}
}

// Function parseField gets a line with markdown field, e.g.
// "* First name ~> first-name" and returns the following object:
//
// {
//     caption: <caption of the input field in markdown format>,
//     name: <name of the variable to capture>,
// }

function parseField(ln) {
    var parts = splitOnce(ln, "~>")
    var caption = parts[0].trim()
    var name = ""
    if(parts.length > 1) name = parts[1].trim()
    testId(name)
    return {caption: caption, name: name}
}

// Function parseTemplate gets the markdown document and
// returns the following object:
//
// {
//     steps: <linear sequence of steps>,
//     stepById: <map from ID to step>,
// }
//
// Individual step looks like this:
//
// {
//     id: <short ID of the step>,
//     title: <human readable title of the step>,
//     deps: <array of step IDs of this step depends on>,
//     parts: <sequence of body parts>,
// }
//
// Each body part can be one of the following:
//
// {
//     type: "html",
//     body: <HTML content of the part>,
// }
//
// {
//     type: "form",
//     fields: <sequnce of input fields>,
// }
//
// Each input field looks like this:
//
// {
//     caption: <caption of the input field in markdown format>,
//     name: <name of the variable to capture>,
// }

function parseTemplate(template) {
    // Convert the template into a list of child nodes.
    var src = document.createElement('div');
    src.innerHTML = mdConvert(template)
    var ch = src.childNodes

    var steps = []
    var stepById = {}

    var step = null
    for(var i = 0; i < ch.length; i++) {
        // Process a step heading.
        if(/H[1-6]/.test(ch[i].nodeName)) {
            if(step != null) {
                steps.push(step)
                stepById[step.id] = step
            }
            var step = parseHeading($(ch[i]).text())
            step["parts"] = []
            continue
        }
        // Process a form field.
        if(ch[i].nodeName == "UL") {
            // Check whether there's wiggly arrow in at least one subitem.
            // If so, we'll consider the list to be a form.
            var subitems = ch[i].childNodes
            var isForm = false
            for(var j = 0; j < subitems.length; j++) {
                if($(subitems[j]).text().includes("~>")) {
                    isForm = true
                    break;
                }
            }
            if(isForm) {
                var field = parseField($(ch[i]).text())
                if(step.parts.length == 0 ||
                      step.parts[step.parts.length - 1].type != "form")
                    step.parts.push({type: "form", fields: []})
                step.parts[step.parts.length - 1].fields.push(field)
                continue
            }
        }
        // Process a common non-Flowium element.
        var html = ch[i].outerHTML
        if(step && html) {
            if(step.parts.length == 0 ||
                  step.parts[step.parts.length - 1].type != "html")
                step.parts.push({type: "html", body: ""})
            step.parts[step.parts.length - 1].body += html
        }
    }
    if(step != null) {
        steps.push(step)
        stepById[step.id] = step
    }

    return {steps: steps, stepById: stepById}
}

////////////////////////////////////////////////////////////////////////////////
//  Preprocessing comments.
////////////////////////////////////////////////////////////////////////////////

// This function takes a text of a single comment and splits it into a
// sequence of objects of the following types:
//
// {
//     type: "comment",
//     body: <HTML content of the comment>,
//     step: <step ID that the comment belongs to> (optional)
// }
// {
//     type: "variables",
//     variables: <map from variable name to variable value>,
// }

function splitCommentsAndVariables(text) {
    // Split the comment into text vs. variable blocks.
    var stepId = null
    var blocks = []
    var lns = text.split('\n')
    for(var i = 0; i < lns.length; i++) {
        var ln = lns[i]
        if(ln.startsWith("~>")) {
            if(blocks.length == 0 ||
                  blocks[blocks.length - 1].type != "variables")
                blocks.push({type: "variables", body: ""})
        } else {
            if(blocks.length == 0 ||
                  blocks[blocks.length - 1].type != "comment")
                blocks.push({type: "comment", body: ""})
        }
        blocks[blocks.length - 1].body += ln + "\n"
    }
    // Remove blocks with empty bodies.
    blocks = blocks.filter(function (block) {
       return block.body.trim().length > 0
    })
    // Convert text blocks from markdown to HTML.
    for(var i = 0; i < blocks.length; i++) {
        var block = blocks[i]
        if(block.type != "comment") continue
        block.body = mdSanitizeAndConvert(block.body)
    }
    // Turn variable definitions into a dictionary.
    // Annotate comments with step IDs along the way.
    for(var i = 0; i < blocks.length; i++) {
        var block = blocks[i]
        if(block.type == "comment") {
            if(stepId != null) block["step"] = stepId
            continue
        }
        block['variables'] = {}
        var lns = block.body.split("\n")
        for(var j = 0; j < lns.length; j++) {
            var ln = lns[j].substring(2).trimStart()
            if(ln.length == 0) continue
            var parts = splitOnce(ln, ":")
            var name = parts[0].trim()
            var value = ""
            if(parts.length > 1) value = parts[1].trimStart()
            if(name == "_step") stepId = value.trim()
            else block.variables[name] = value
        }
        delete block["body"]
    }    
    return blocks
}

// Function processComments gets an issue and a comments object as it was
// provided by GitHub API and returns the following object:
//
// {
//     comments: <chronological array of comments>,
//     commentsByStep: <map from step ID to a list of associated comments>,
// }
//
// Each comment can be one of the following:
//
// {
//     type: "comment",
//     body: <HTML content of the comment>,
//     user: <GitHub username of the creator of the comment>,
//     avatar: <link to user's avatar>,
//     created: <time when the comment was created>,
//     step: <step ID that the comment belongs to> (optional)
// }
// {
//     type: "variables",
//     variables: <map from variable name to variable value>,
//     user: <GitHub username of the creator of the comment>,
//     avatar: <link to user's avatar>,
//     created: <time when the comment was created>,
// }

function processComments(issue, comments) {
    comments.unshift(issue)
    var cmnts = []
    var cmntsByStep = {}
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        sc = splitCommentsAndVariables(c.body)
        for(var j = 0; j < sc.length; j++) {
            sc[j].user = c.user.login
            sc[j].avatar = c.user.avatar_url
            sc[j].created = new Date(c.created_at).toLocaleString()
            cmnts.push(sc[j])
            if("step" in sc[j]) {
                var stepId = sc[j].step
                if(!(stepId in cmntsByStep)) cmntsByStep[stepId] = []
                cmntsByStep[stepId].push(sc[j])
            }
        }
    }
    return {comments: cmnts, commentsByStep: cmntsByStep}
}

////////////////////////////////////////////////////////////////////////////////
//  Steps.
////////////////////////////////////////////////////////////////////////////////

function initSteps(steps, commentsByStep) {
    for(var i = 0; i < steps.steps.length; i++) {
        var step = steps.steps[i]
        var card = $(`<div class="card flowium-step"></div>`)
        var hdr = $(`<div class="card-header flowium-card-header"></div>`)
        hdr.append($(`<h5 class="step-title"></h5>`).text(step.title)
            .prepend(`<i class="fa fa-circle comment-icon ` +
            `${step.status}-font">`))
        hdr.click(function () {
            var hidden = $(this).next().is(":hidden")
            $(".step-body").hide()
            if(hidden) $(this).next().show()
        })
        card.append(hdr)
        var body = $(`<div class="card-body step-body" ` +
            `style="display: none;"></div>`)
        // Render the actual body of the step.
        for(var j = 0; j < step.parts.length; j++) {
            var part = step.parts[j]
            if(part.type == "html") {
                body.append(part.body)
                continue
            }
            if(part.type == "form") {
                for(var k = 0; k != part.fields.length; k++) {
                    var field = part.fields[k]
                }
            }
        }
        // Add step-level comments.
        var comments = commentsByStep[step.id]
        if(comments != undefined) {
            for(var j = 0; j < comments.length; j++) {
                body.append(renderComment(comments[j], null, null,
                    comments[j].body))
            }
        }
        // Add the buttons on the bottom of the step.
        body.append(`<div class="form-group"><textarea class="form-control"
            id="history-comment" rows="4"></textarea></div>`)
        if(step.status == "done") {
            body.append(`<button type="button"
                class="btn btn-primary">Not done</button>`)
        } else {
            body.append(`<button type="button"
                class="btn btn-primary">Comment</button><button type="button"
                class="btn btn-primary">Done</button>`)
        }
        card.append(body)
        $("#steps-main").append(card)
    }
}

////////////////////////////////////////////////////////////////////////////////
//  Graph.
////////////////////////////////////////////////////////////////////////////////

function initGraph(steps) {
    var dot =`
        digraph "" {
        node [
            shape=box
            style="filled,rounded"
            fontname="Helvetica"
            fontsize=10
            width=0
            height=0
            tooltip=" "
        ]
        `
    for(var i = 0; i < steps.length; i++) {
        var s = steps[i]
        dot += `
            "${s.id}" [
                label="${s.title}"
                fillcolor="${statusToColor(s.status)}"
                URL="javascript:scrollToStep('${s.id}');"
            ]
            `
        for(var j = 0; j < s['deps'].length; j++) {
            if(s['deps'][j].trim() != '') {
                dot += `
                    "${s.deps[j]}" -> "${s.id}"
                `
            }
        }
    }
    dot += "}"
    d3.select("#graph-main").graphviz().fade(false).renderDot(dot)
}

////////////////////////////////////////////////////////////////////////////////
//  Variables.
////////////////////////////////////////////////////////////////////////////////

function initVariables(repository, issue, vars) {
    var keys = Object.keys(vars).sort()
    for(var i = 0; i < keys.length; i++) {
        var tr = $(`<tr class="clickable-element"></tr>`)
        tr.click((function(name, value) {return function() {
            $("#variable-name").val(name)
            $("#variable-value").val(value)
        }})(keys[i], vars[keys[i]]))
        tr.append($("<td></td>").text(keys[i]))
        tr.append($("<td></td>").text(vars[keys[i]]))
        $("#variable-table").append(tr)
    }

    // When the button is pressed one variable is updated.
    $("#variable-save").click(function () {
        var name = $("#variable-name").val()
        var value = $("#variable-value").val()
        var body = `~> ${name}: ${value}`
        ghPost(`repos/${repository}/issues/${issue}/comments`,
              {"body": body}, function(reply) { 
            location.reload();
        })
    })
}

////////////////////////////////////////////////////////////////////////////////
//  History.
////////////////////////////////////////////////////////////////////////////////

function renderComment(comment, icon, iconText, text) {
    // Comment header.
    var hdr = $(`<div class="card-header flowium-card-header"></div>`)
    hdr.append($(`<img class="rounded comment-avatar"/>`)
        .attr("src", comment.avatar + "&s=32"))
    hdr.append($("<a></a>")
        .text(comment.user)
        .attr("href", `https://github.com/${comment.user}`))
    hdr.append($(`<span class="float-right"></span>`)
        .text(comment.created))
    // Comment body.
    var body = $(`<div class="card-body"></div>`)
    var ic = $(`<p><i class="fa ${icon} comment-icon"></i></p>`)
        .append(iconText)
    body.append($("<b></b>").html(ic))
    body.append(text)
    // Entire comment card.
    var card = $(`<div class="card flowium-comment"></div>`)
        .append(hdr)
        .append(body)
    return card
}

function initHistory(repository, issue, comments, steps) {
    var cards = []
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        // Render user's comment.
        if(c.type == "comment") {
            var info = "Comment"
            if("step" in c) {
                info += ` on step "${steps[c.step].title}"`
            }
            cards.push(renderComment(c, "fa-pencil", info, c.body))
            continue
        }
        if(c.type == "variables") {
            // Render system variables.
            var names = Object.keys(c.variables).sort()
            for(var j = 0; j < names.length; j++) {
                var name = names[j]
                var value = c.variables[names[j]]
                if(name == "_template") {
                    var parts = splitOnce(value, ":")
                    var template = escapeHtml(parts[0].trim())
                    var version = escapeHtml(parts[1].trim())
                    cards.push(renderComment(c, "fa-cog", "Template",
                        `Use template <b>${template}` +
                        `</b> version <b>${version}</b>.`))
                }
            }
            // Render user-defined variables.
            var text = ""
            var names = Object.keys(c.variables).sort()
            for(var j = 0; j < names.length; j++) {
                if(names[j].startsWith("_")) continue
                text += `<p>Variable <b>${escapeHtml(names[j])}</b> set to ` +
                    `<b>${escapeHtml(c.variables[names[j]])}</b>.</p>`
            }
            if(text.length > 0) {
                cards.push(renderComment(c, "fa-question", "Variables", text))
            }
        }
    }
    $("#history-main").append(cards)

    // Clicking on the "Comment" button creates a global comment.
    $("#comment-button").click(function () {
        var body = $("#history-comment").val()
        ghPost(`repos/${repository}/issues/${issue}/comments`,
              {"body": body}, function(reply) { 
            location.reload();
        })
    })
}

////////////////////////////////////////////////////////////////////////////////
//  Main.
////////////////////////////////////////////////////////////////////////////////

$(document).ready(function() {
    authenticate()
    // Parse query string.
    var urlParams = new URLSearchParams(window.location.search)
    var issueRepository = urlParams.get("repository")
    var issueNumber = urlParams.get("issue")
    // Get the data from GitHub.
    ghGet(`repos/${issueRepository}/issues/${issueNumber}`, null,
          function(issue) {
        ghGet(`repos/${issueRepository}/issues/${issueNumber}/comments`, null,
              function(cmnts) {
            var comments = processComments(issue, cmnts)
            // Merge the variables from comments to get the current status quo.
            var variables = {}
            for(var i = 0; i < comments.comments.length; i++) {
                var comment = comments.comments[i]
                if(comment.type != "variables") continue
                variables = Object.assign(variables, comment.variables)
            }
            // Get the template file.
            if(!"_template" in variables) {
                throw "Template file not specified in the issue!"
            }
            var parts = variables["_template"].split(':')
            var template = parts[0].trim()
            var version = parts[1].trim()
            ghGet(`repos/${issueRepository}/contents${template}` +
                  `?ref=${version}`, {}, function(src) {
                var steps = parseTemplate(atob(src.content))
                // Collect statuses from comments.
                var statusById = {}
                for(var i = 0; i != steps.steps.length; i++) {
                    var id = steps.steps[i].id
                    var status = "not-done"
                    var vname = "_status+" + id
                    if(vname in variables)
                        status = variables[vname]
                    statusById[id] = status
                }
                // Annotate the steps with statuses.
                for(var i = 0; i != steps.steps.length; i++) {
                    var step = steps.steps[i]
                    if(statusById[step.id] == "done") {
                        step["status"] = "done"
                        continue
                    }
                    // Steps that are not yet done will be either 'active' or
                    // 'blocked' based on the status of the dependecies.
                    var deps = step.deps
                    var blocked = false
                    for(j = 0; j < step.deps.length; j++) {
                        var depId = step.deps[j]
                        if(statusById[depId] != "done") {
                            blocked = true
                            break
                        }
                    }
                    if(blocked) step["status"] = "blocked"
                    else step["status"] = "active"
                }
                
                // At this point we are done with data collection and
                // preprocessing we can more to rendering the page.
                
                // The page title is the title of the GitHub issue.
                $("#title").prepend(issue.title)
                $(document).attr("title", issue.title);
                // Initialize different tabs on the page.
                initSteps(steps, comments.commentsByStep)
                initGraph(steps.steps)
                initHistory(issueRepository, issueNumber, comments.comments,
                    steps.stepById)
                initVariables(issueRepository, issueNumber, variables)

                $("#inspect-variables").click(function () {
                    $(".more-tab").hide()
                    $("#more-variables").show()
                })
                $("#gh-link-template").attr("href",
                    `https://github.com/sustrik/flowium-sandbox/blob/` +
                    `${template[1]}/${template[0]}`)
                $("#gh-edit-template").attr("href",
                    `https://github.com/sustrik/flowium-sandbox/edit/master/` +
                    `${template[0]}`)
                $("#gh-update-template").click(function () {
                    // TODO
                })
                $("#gh-link-issue").attr("href",
                    `https://github.com/${issueRepository}/issues/` +
                    `${issueNumber}`)
                $("#cancel-more").click(function () {
                    $(".more-tab").hide()
                    $("#more-index").show()
                })
                $("#back-to-index").click(function () {
                    window.location.href = "index.html"
                })

                // Add the issue to the list of recent issues.
                var recent = JSON.parse(localStorage.getItem("recent"))
                if(recent == null) recent = []
                recent = recent.filter(function(it) {
                    return it.repository != issueRepository ||
                        it.issue != issueNumber
                })
                recent.unshift({
                    repository: issueRepository,
                    issue: issueNumber,
                    title: issue.title,
                })
                recent = recent.slice(0, 20)
                localStorage.setItem("recent", JSON.stringify(recent))
            })
        })
    })
})

</script>
<body>
  
<div class="container-fluid">

  <h1 id="title" class="flowium-title"><small><i id="back-to-index"
    class="float-right fa fa-close cancel-icon"></i></small></h1>

  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" data-toggle="tab" href="#steps">
          Steps</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-toggle="tab" href="#graph">
          Graph</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-toggle="tab" href="#history">
          History</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-toggle="tab" href="#more">
          More</a>
    </li>
  </ul>

  <br>

  <div class="tab-content">

    <div id="steps" class="container tab-pane active">
      <h3>Steps</h3>
      <br> 
      <div id="steps-main"></div>
    </div>

    <div id="graph" class="container tab-pane fade">
      <h3>Workflow graph</h3>
      <br>
      <p>This graph shows the dependencies between the steps.
         The steps are clickable.</p>
      <br>
      <div id="graph-main"></div>
      <br>
      <p><i class="fa fa-circle comment-icon done-font"></i>
        Steps that are done are grey.</p>
      <p><i class="fa fa-circle comment-icon active-font"></i>
        Active steps are green.</p>
      <p><i class="fa fa-circle comment-icon blocked-font"></i>
        Blocked steps are red.</p>
    </div>

    <div id="history" class="container tab-pane fade">
      <h3>History of the issue</h3>
      <br>
      <div id="history-main"></div>
      <br>
      <div class="form-group">
        <textarea class="form-control" id="history-comment" rows="6"></textarea>
      </div>
      <button id="comment-button" type="button" class="btn btn-primary">
          Comment</button>
    </div>

    <div id="more" class="container tab-pane fade">
      <div id="more-index" class="more-tab">
        <h3>More options</h3>
        <br>
        <p><a id="inspect-variables" href="#">
          Inspect the variables</a></p>
        <p><a id="gh-link-template" target="_blank">
          Show the version of the template currently used by this issue</a></p>
        <p><a id="gh-edit-template" target="_blank">
          Edit the newest version of the issue template</a></p>
        <p><a id="gh-update-template" href="#">
          Update to the different version of the template</a></p>
        <p><a id="gh-link-issue" target="_blank">
          Go to the GitHub issue</a></p>
        <p><a href="https://github.com/sustrik/flowium/issues/new" target="_blank">
          Report a bug in Flowium</a></p>
      </div>
      <div id="more-variables" class="more-tab" style="display: none;">
        <h3>
          Variables
          <i id="cancel-more" class="float-right fa fa-close cancel-icon"></i>
        </h3>
        <br>
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Name</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody id="variable-table"></tbody>
        </table>
        <div class="form-group">
            <label for="variable-name">Name:</label>
            <input type="text" class="form-control" id="variable-name"></input>
        </div>
        <div class="form-group">
            <label for="variable-value">Value:</label>
            <input type="text" class="form-control" id="variable-value"></input>
        </div>
        <button id="variable-save" type="button" class="btn btn-primary">
            Save</button>
      </div>
    </div>
  </div>

</div>

</body>
</html>
