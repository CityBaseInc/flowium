<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>flowium</title>
    <link rel="stylesheet" type="text/css" href="flowium.css">
</head>
<script
    src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous">
</script>
<script src="https://cdn.rawgit.com/showdownjs/showdown/1.8.5/dist/showdown.min.js"></script>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://unpkg.com/viz.js@1.8.0/viz.js" type="javascript/worker"></script>
<script src="https://unpkg.com/d3-graphviz@1.4.0/build/d3-graphviz.min.js"></script>

<script src="utils.js"></script>
<script>

////////////////////////////////////////////////////////////////////////////////
//  Parsing the flow source code.
////////////////////////////////////////////////////////////////////////////////

function parseSteps(source, variables) {
    var lns = source.split("\n")
    var steps = []
    var stepname = null
    var step = ""
    var title = ""
    var deps = []
    for(var i = 0; i < lns.length; i++) {
        var ln = lns[i]
        if(ln.startsWith("#") && ln.includes("~>")) {
            if(stepname != null) {
                steps.push({
                    id: stepname,
                    title: title,
                    body: step,
                    deps: deps
                })
            }
            title = ""
            step = ""
            deps = []
            var ruleparts = splitOnce(ln, "~>")
            title = ltrimHash(ruleparts[0]).trim()
            var elems = splitOnce(ruleparts[1].trim(), ":")
            stepname = elems[0].trim()
            if (elems.length > 1) {
                d = elems[1].trim().split(/\s+/)
                for(var j = 0; j < d.length; j++) {
                    deps.push(d[j])
                }
            }
            continue
        }
        step += ln + "\n"
    }
    if(stepname != null) {
        steps.push({
            id: stepname,
            title: title,
            body: step,
            deps: deps
        })
    }

    // Expand the input statements.
    for(var j = 0; j < steps.length; j++) {
        var body = ""
        var lns = steps[j].body.split("\n")
        for (var i = 0; i < lns.length; i++) {
            var ln = lns[i]
            if(!ln.startsWith("~>")) {
                body += ln + "\n"
                continue
            }
            ln = ln.substring(2).trim()
            if(ln.startsWith("input ")) {
                var vars = ln.substring(6).split(/\s+/)
                for(var k = 0; k < vars.length; k++) {
                    body += "<p>" + vars[k] + ": <input/></p>"
                }
                body += "<button onclick=''>Save</button>"
            }
            // TODO other commands
        }
        steps[j].body = body
    }

    // Expand the variables.
    var keys = Object.keys(variables)
    for(var i = 0; i < steps.length; i++) {
        for(var j = 0; j < keys.length; j++) {
            steps[i].body = steps[i].body.replace(
                new RegExp('#{' + keys[j] + '}', 'g'), variables[keys[j]])
        }
    }

    return steps
}

function annotateStepsWithStatus(steps, sysvars) {
    var statuses = {}
    // Check whether steps are done or not done.
    for(var i = 0; i != steps.length; i++) {
        var status = "not-done"
        var vname = "_status+" + steps[i].id
        if(vname in sysvars)
            status = sysvars[vname]
        steps[i]["status"] = status
        statuses[steps[i].id] = status
    }
    // Steps that are not yet done can be also blocked.
    for(var i = 0; i != steps.length; i++) {
        if(steps[i].status == "done") {
            steps[i]["dstatus"] = "done"
            steps[i]["blockedBy"] = []
            continue
        }
        var deps = steps[i].deps
        var blockedBy = []
        for(j = 0; j < deps.length; j++) {
            if(statuses[deps[j]] != "done") {
                blockedBy.push(deps[j])
            }
        }
        steps[i]["blockedBy"] = blockedBy
        if(blockedBy.length == 0) steps[i]["dstatus"] = "active"
        else steps[i]["dstatus"] = "blocked"
    }
}

function annotateStepsWithComments(steps, comments) {
    for(var i = 0; i != steps.length; i++) {
        var step = steps[i]
        var res = []
        for(var j = 0; j != comments.length; j++) {
            var comment = comments[j]
            if(comment.type != "comment" || !("step" in comment)) continue
            if(comment.step != step.id) continue
            res.push(comment)
        }
        step['comments'] = res
    }
}

////////////////////////////////////////////////////////////////////////////////
//  Preprocessing comments.
////////////////////////////////////////////////////////////////////////////////

function splitVariables(res, text) {
    var userVariables = {}
    var systemVariables = {}
    var lns = text.split('\n')
    for(var i = 0; i < lns.length; i++) {
        var ln = lns[i]
        var vdef = splitOnce(lns[i].substring(2), ":")
        var name = vdef[0].trim()
        if(vdef.length < 2) {
            var value = ""
        } else {
            var value = vdef[1].trim()
        }
        if(name.startsWith("_")) systemVariables[name] = value
        else userVariables[name] = value
    }
    if(Object.keys(systemVariables).length > 0)
        res.push({type: 'sysvars', vars: systemVariables})
    if(Object.keys(userVariables).length > 0)
        res.push({type: 'vars', vars: userVariables})
}

function splitCommentsAndVariables(text) {
    var res = []
    var variable = true
    var body = ""
    var lns = text.split('\n')
    for(var i = 0; i < lns.length; i++) {
        if(lns[i].startsWith("~>")) {
            if(!variable && body != "") {
                if(body.trim().length > 0)
                    res.push({type: 'comment', body: body.trim()})
                body = ""
            }
            variable = true
        } else {
            if(variable && body != "") {
                splitVariables(res, body.trim())
                body = ""
            }
            variable = false
        }
        body += "\n" + lns[i]
    }
    if(variable) {
        splitVariables(res, body.trim())
    } else {
        if(body.trim().length > 0)
            res.push({type: 'comment', body: body.trim()})
    }

    // Pair comments to steps.
    var step = null
    for(var i = 0; i < res.length; i++) {
        var it = res[i]
        if(it.type == 'sysvars' && "_step" in it.vars) {
            step = it.vars["_step"]
            delete it.vars["_step"]
            if(Object.keys(it.vars).length == 0) {
                res.splice(i, 1)
                i--
            }
            continue    
        }
        if(step != null && it.type == "comment")
            it.step = step
    }

    return res
}

function processComments(comments) {
    var res = []
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        sc = splitCommentsAndVariables(c.body)
        for(var j = 0; j < sc.length; j++) {
            sc[j].userName = c.user.login
            sc[j].userUrl = c.user.html_url
            sc[j].userAvatar = c.user.avatar_url
            sc[j].createdAt = c.created_at
            res.push(sc[j])
        }
    }
    return res
}

function extractVariablesFromComments(comments, type) {
    var result = {}
    for(var i = 0; i < comments.length; i++) {
        if(comments[i].type == type) {
            result = Object.assign(result, comments[i].vars)
        }
    }
    return result
}

////////////////////////////////////////////////////////////////////////////////
//  Main tab.
////////////////////////////////////////////////////////////////////////////////

function showSteps(show, type) {
    if(show) $("." + type).show()
    else $("." + type).hide()
}

function postStepComment(step) {
    var prefix = "~> _step: " + step + "\n\n"
    postComment("comment-" + step, prefix)
}

function postStepDone(step) {
    var prefix = "~> _status+" + step + ": done\n\n"
    postComment("comment-" + step, prefix)
}

function postStepNotDone(step) {
    var prefix = "~> _status+" + step + ": not-done\n\n"
    postComment("comment-" + step, prefix)
}

function closeIssue() {
    ghPost("issues/" + getIssue(), {"state": "closed"},
          function(reply) { 
        window.location.href = window.location.pathname +
            window.location.search + window.location.hash;
    })
}

function initMain(steps) {
    for(var i = 0; i < steps.length; i++) {
        var div = "<div id='__" + steps[i].id
        div += "' class=" + steps[i].dstatus + ">"
        div += "<div class='status-sign' style='background-color:" 
        div += statusToColor(steps[i].dstatus) + ";'></div>"
        div += "<h2>" + steps[i].title + "</h2>"
        for(var j = 0; j < steps[i].blockedBy.length; j++) {
            div += "<p><b>Blocked by <a href='javascript:scrollToStep(\"" +
                steps[i].blockedBy[j] +
                "\")'>" + steps[i].blockedBy[j] +
                "</a>.</b></p>"
        }
        div += mdConvert(steps[i].body)
        for(var j = 0; j != steps[i].comments.length; j++) {
            div += renderComment(steps[i].comments[j])
        }
        div += "<p><textarea id='comment-" + steps[i].id + 
            "' cols='40' rows='5'></textarea></p>"
        div += "<p><button onclick='postStepComment(\"" + steps[i].id +
            "\")'>Comment</button>"
        if(steps[i].status == "done") {
            div += "<button onclick='postStepNotDone(\"" + steps[i].id +
                "\")'>Mark as not done</button>"
        } else {
            div += "<button onclick='postStepDone(\"" + steps[i].id +
                "\")'>Mark as done</button>"
        }
        div += "</p><hr></div>"
        $("#main-steps").append(div)
    }

    showSteps(true, "active")
    showSteps(false, "blocked")
    showSteps(false, "done")
}

////////////////////////////////////////////////////////////////////////////////
//  Flow tab.
////////////////////////////////////////////////////////////////////////////////

function initFlow(steps) {
    var dot = "digraph \"\" {\nnode [fontname=\"Helvetica\" fontsize=10 " +
        "width=0 height=0 tooltip=\" \"]\n"
    for(var i = 0; i < steps.length; i++) {
        var s = steps[i]
        dot += '"' + s['id'] + '" [label="' + s['title'] +
            '" shape=box style=filled ' +
            'fillcolor="' + statusToColor(s.dstatus) +
            '" URL="javascript:scrollToStep(\'' + s['id'] +
            '\');"]\n'
        for(var j = 0; j < s['deps'].length; j++) {
            if(s['deps'][j].trim() != '') {
                dot += "\"" + s['deps'][j] + "\" -> \"" + s['id'] + "\"\n"
            }
        }
    }
    dot += "}"
    console.log(dot)
    d3.select("#flow-main").graphviz().fade(false).renderDot(dot)
}

////////////////////////////////////////////////////////////////////////////////
//  Variables tab.
////////////////////////////////////////////////////////////////////////////////

function updateVariable() {
    var name = $("#variable-name").val()
    var value = $("#variable-value").val()
    var body = "~> " + name + ": " + value
    ghPost("issues/" + getIssue() + "/comments", {"body": body},
          function(reply) { 
        window.location.href = window.location.pathname +
            window.location.search + window.location.hash;
    })
}

function initVariables(vars) {
    var table = $("<table></table>")
    var keys = Object.keys(vars).sort()
    for(var i = 0; i < keys.length; i++) {
        var key = $("<td></td>").text(keys[i])
        var val = $("<td></td>").text(vars[keys[i]])
        var row = $("<tr></tr>").append(key, val)
        table.append(row)
    }
    $("#variable-table").append(table)
}

////////////////////////////////////////////////////////////////////////////////
//  History tab.
////////////////////////////////////////////////////////////////////////////////

function renderUser(comment) {
    return "<img class='avatar' src='" + comment.userAvatar +
        "&s=44'/><a href='" + comment.userUrl + "'>" + comment.userName +
        "</a>"
}

function renderComment(comment) {
    var body = "<p>" + renderUser(comment) + " commented"
    if ('step' in comment) {
        body += " on step <a href='javascript:scrollToStep(\"" + comment.step +
            "\");'>" + comment.step + "</a>"
    }
    body += " at " + comment.createdAt + "</p>"
    body += "<div class='comment'>"
    body += mdConvert(comment.body)
    body += "</div>"
    return body
}

function renderVarChange(comment) {
    var body = "<p>" + renderUser(comment) + " set variables"
    body += " at " + comment.createdAt + "</p>"
    body += "<div class='comment'>"
    var names = Object.keys(comment.vars).sort()
    for(var i = 0; i < names.length; i++) {
        body += "<p>Variable " + names[i] + " set to \"" + comment.vars[names[i]] + "\"</p>"
    }
    body += "</div>"
    return body
}

function renderSysvarChange(comment) {
    body = ""
    var names = Object.keys(comment.vars).sort()
    for(var i = 0; i < names.length; i++) {
        var name = names[i]
        if(name.startsWith("_status+")) {
            body += "<p>" + renderUser(comment) + " changed state of a step"
            body += " at " + comment.createdAt + "</p>"
            body += "<div class='comment'>"
            body += "<p>Step " + splitOnce(name, "+")[1] + " was marked as " + comment.vars[name] + "</p>"
            body += "</div>"
        }
        // TODO: Other sysvars
    }
    return body
}

function initHistory(comments) {
    for(var i = 0; i < comments.length; i++) {
        var c = comments[i]
        var div = null
        if(c.type == 'comment') {
            div = renderComment(c)
        }
        else if (c.type == 'vars') {
            div = renderVarChange(c)
        }
        else if (c.type == 'sysvars') {
            div = renderSysvarChange(c)
        }
        $("#history-table").append(div)
    }
}

////////////////////////////////////////////////////////////////////////////////

$(document).ready(function() {
    ghGet('issues/' + getIssue(), null, function(issue) {
        $("#title").text(issue.title)
        ghGet('issues/' + getIssue() + "/comments", null, function(cmnts) {
            cmnts.unshift(issue)
            var comments = processComments(cmnts)
            var sysvars = extractVariablesFromComments(comments, "sysvars")
            var vars = extractVariablesFromComments(comments, "vars")
            var template = sysvars["_template"].split(':')
            ghGet("contents/" + template[0] + "?ref=" + template[1], {},
                  function(src) {
                var steps = parseSteps(atob(src.content), vars)
                annotateStepsWithStatus(steps, sysvars)
                annotateStepsWithComments(steps, comments)
                console.log(steps)
                initMain(steps)
                initFlow(steps)
                initVariables(vars)
                initHistory(comments)
            })
        })
    })
})

function switchTab(name) {
    $("#main").hide()
    $("#variables").hide()
    $("#history").hide()
    $("#flow").hide()
    $("#" + name).show()
}

function scrollToStep(id) {
    switchTab("main")
    $("#__" + id)[0].scrollIntoView()
}

function postComment(elid, prefix) {
    var body = prefix + $("#" + elid).val()
    ghPost("issues/" + getIssue() + "/comments", {"body": body},
          function(reply) { 
        window.location.href = window.location.pathname +
            window.location.search + window.location.hash;
    })
}

</script>
<body>
<h1 id="title"></h1>
<p>
<button onclick="switchTab('main')">Main</button>
<button onclick="switchTab('flow')">Flow</button>
<button onclick="switchTab('variables')">Variables</button>
<button onclick="switchTab('history')">History</button>
</p>
<div id="main">
   <p>
       <input type='checkbox' checked onchange="showSteps(this.checked, 'active');">Show active</input>
       <input type='checkbox' onchange="showSteps(this.checked, 'blocked');">Show blocked</input>
       <input type='checkbox' onchange="showSteps(this.checked, 'done');">Show done</input>
   </p>
   <div id="main-steps"></div>
   <p><button onclick="closeIssue()">Close the issue</button></p>
</div>
<div id="variables" hidden>
    <div id="variable-table"></div>
    <p>Variable: <input id="variable-name"/> Value: <input id="variable-value"/></p>
    <button onclick="updateVariable()">Update variable</button>
</div>
<div id="history" hidden>
    <div id="history-table"></div>
    <p><textarea id='comment' cols='40' rows='5'></textarea></p>
    <p><button onclick="postComment('comment', '')">Comment</button></p>
</div>
<div id="flow" hidden>
    <div id="flow-main"></div>
</div>
</body>

