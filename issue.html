<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>flowium</title>
    <link rel="stylesheet" type="text/css" href="flowium.css">
</head>
<script
    src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous">
</script>
<script src="https://cdn.rawgit.com/showdownjs/showdown/1.8.5/dist/showdown.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
<script src="utils.js"></script>
<script>

function splitComment(el) {
    var src = el.body
    var vars = {}
    var body = ""
    var lns = src.split("\n")
    for(var i = 0; i < lns.length; i++) {
        if(lns[i].startsWith("~>")) {
            var elems = lns[i].substring(2).split(":")
            vars[elems[0].trim()] = elems[1].trim()
            continue
        }
        body += "\n" + lns[i]
    }
    return {
        user: el.user.login,
        created_at: el.created_at,
        variables: vars,
        body: body,
    }
}

function extractComments(issue, comments) {
    var result = []
    result.push(splitComment(issue))
    for(var i = 0; i < comments.length; i++) {
        result.push(splitComment(comments[i]))
    }
    return result
}

function extractVariables(comments) {
    var result = {}
    for(var i = 0; i < comments.length; i++) {
        result = Object.assign(result, comments[i].variables)
    }
    // "action" is not a real variable.
    delete result['__action']
    return result
}

function initFlow(comments, source, variables) {
    /* Parse the source. */
    var lns = source.split("\n")
    var steps = []
    var stepname = "__introduction"
    var step = ""
    var title = ""
    var deps = []
    for(var i = 0; i < lns.length; i++) {
        var ln = lns[i]
        if(ln.startsWith("#") && ln.includes("~>")) {
            steps.push({
                id: stepname,
                title: title,
                body: step,
                deps: deps
            })
            title = ""
            step = ""
            deps = []
            var ruleparts = ln.split("~>")
            title = ltrimHash(ruleparts[0]).trim()
            var elems = ruleparts[1].trim().split(":")
            stepname = elems[0].trim()
            if (elems.length > 1) {
                deps = elems[1].split(' ')
            }
            continue
        }
        step += ln
    }
    steps.push({
        id: stepname,
        title: title,
        body: step,
        deps: deps
    })

    /* Expand the variables. */
    var keys = Object.keys(variables)
    for(var i = 0; i < steps.length; i++) {
        for(var j = 0; j < keys.length; j++) {
            steps[i].body = steps[i].body.replace(new RegExp('#{' + keys[j] + '}', 'g'), variables[keys[j]])
        }
    }

    /* Render the page. */
    $("#flow").append("<p><input type='checkbox'>Show blocked</input><input type='checkbox'>Show done</input></p>")
    for(var i = 0; i < steps.length; i++) {
        var div = "<div id='__" + steps[i].id + "'>"
        div += "<h2>" + steps[i].title + "</h2>"
        div += mdConvert(steps[i].body)
        div += "<p><textarea cols='40' rows='5'></textarea></p>"
        div += "<p><button onclick=''>Save comment</button></p>"
        div += "<p><button onclick=''>Not done</button>"
        div += "<button onclick=''>In progress</button>"
        div += "<button onclick=''>Done</button></p>"
        div += "<hr></div>"
        $("#flow").append(div)
    }
}

function initVariables(comments, source, variables) {
    var body = "<table>"
    var keys = Object.keys(variables).sort()
    for(var i = 0; i < keys.length; i++) {
        var key = keys[i]
        var val = variables[key]
        body += "<tr><td>" + key + "</td><td>" + val + "</td></tr>"
    }
    body += "</table>"
    $("#variable-table").append(body)
}

function initHistory(comments, source, variables) {
    for(var i = 0; i < comments.length; i++) {
        var body = "<p>user " + comments[i].user + " at " + comments[i].created_at + "</p>"
        body += "<div class='comment'>"
        if(comments[i].variables["__action"] != undefined) {
            body += "<p>Action:" + comments[i].variables.__action + "</p>"
        }
        body += mdConvert(comments[i].body)
        body += "</div>"
        $("#history-table").append(body)
    }

    var commentElement = document.getElementById("comment")
    commentElement['editor'] = new SimpleMDE({
		    element: commentElement,
		    spellChecker: false,
	  })
}

function init() {
    ghGet('issues/' + getIssue(), null, function(issue) {
        $("#title").text(issue.title)
        ghGet('issues/' + getIssue() + "/comments", null, function(cmnts) {
            var comments = extractComments(issue, cmnts)
            var variables = extractVariables(comments)
            var template = variables["__template"]
            var version = variables["__version"]
            ghGet("contents/" + template + "?ref=" + version, {}, function(src) {
                var source = atob(src.content)
                initFlow(comments, source, variables)
                initVariables(comments, source, variables)
                initHistory(comments, source, variables)
            })
        })
    })
}

function switchTab(name) {
    $("#flow").hide()
    $("#variables").hide()
    $("#history").hide()
    $("#" + name).show()
}

</script>
<body onload="init()">
<h1 id="title"></h1>
<p>
<button onclick="switchTab('flow')">Flow</button>
<button onclick="switchTab('variables')">Variables</button>
<button onclick="switchTab('history')">History</button>
</p>
<div id="flow"></div>
<div id="variables" hidden>
    <div id="variable-table"></div>
    <p>Key: <input/></p>
    <p>Value: <input/></p>
    <button onclick="">Update variable</button>
</div>
<div id="history" hidden>
    <div id="history-table"></div>
    <p><textarea id='comment' cols='40' rows='5'></textarea></p>
    <p><button onclick="">Comment</button></p>
</div>
</body>

